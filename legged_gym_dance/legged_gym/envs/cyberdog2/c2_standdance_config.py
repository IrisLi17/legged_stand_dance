from legged_gym.envs.cyberdog2.c2_common_config import CyberCommonCfg, CyberCommonCfgPPO
import numpy as np

use_vel = True
ob_t = False
init_pose = "sit"
class CyberStandDanceConfig(CyberCommonCfg):
    class env(CyberCommonCfg.env):
        num_state_history = 3
        num_single_state = 42 + 3 + 2 + 1 * int(ob_t) + 6# add command # add hand targets!!
        num_observations = num_state_history * num_single_state
        priv_obs_friction = True
        priv_obs_restitution = True
        priv_obs_joint_friction = True
        priv_obs_contact = True
        priv_obs_com = True
        priv_obs_mass = True
        num_privileged_obs = num_observations + 3 + 3 \
            + 1 * int(priv_obs_friction)  + 1 * int(priv_obs_restitution) + 12 * int(priv_obs_joint_friction) \
            + 11 * int(priv_obs_contact) + 3 * int(priv_obs_com) + 1 * int(priv_obs_mass)
        vel_cmd = use_vel
        obs_t = ob_t
        
        target_cycle=150
        fix_target=[
                    # [ 0.1124,  0.0848, -0.2599,  0.1157, -0.0842, -0.2649], # dummy

                    # manually written trajectory: reaching out front legs
                    [-0.0466,  0.1356, -0.0651,  0.1715, -0.1351, -0.2736],
                    [ 0.1800,  0.1352, -0.1624,  0.1773, -0.1348, -0.1530],
                    [ 0.1652,  0.1352, -0.2692, -0.0440, -0.1349, -0.0650],
                    [ 0.1800,  0.1352, -0.1624,  0.1773, -0.1348, -0.1530],
                    [-0.0466,  0.1356, -0.0651,  0.1715, -0.1351, -0.2736],
                    [ 0.1800,  0.1352, -0.1624,  0.1773, -0.1348, -0.1530],
                    [ 0.1652,  0.1352, -0.2692, -0.0440, -0.1349, -0.0650],
                    
                    # [-0.0342,  0.1360, -0.1637, -0.0342, -0.1360, -0.1637], #llm wave
                    # [-0.0342,  0.1360, -0.1637, -0.0342, -0.1360, -0.1637],
                    # [ 0.1947,  0.1360, -0.2553, -0.0342, -0.1360, -0.1637],
                    # [ 0.1947,  0.1360, -0.2553, -0.0342, -0.1360, -0.1637],
                    # [-0.0342,  0.1360, -0.1637, -0.0342, -0.1360, -0.1637],

                    # [ 0.2227,  0.1360, -0.2348,  0.2227, -0.1360, -0.2348], #llm ballet
                    # [-0.0529,  0.2194, -0.1026, -0.0529, -0.2194, -0.1026], # open to the sides(Arabesque)
                    # [ 0.2001,  0.2148, -0.2406,  0.2001, -0.2148, -0.2406], # rise up(Attitude)
                    # [ 0.2558,  0.1360, -0.1946,  0.2558, -0.1360, -0.1946], # drop down(Plie)
                    # [-0.0529,  0.2194, -0.1026, -0.0529, -0.2194, -0.1026]

                    # Motion parsed from videos
                    # [-0.17858180990852415, 0.1045181255710125, -0.06329949462264776, -0.13403549080222846, -0.1673227628368139, -0.11718974119126796] ,
                    # [0.3749189628362656, 0.17487417907714842, -0.12031046966314315, -0.1584741213713586, -0.13961433111220597, -0.04635349208017191] ,
                    # [0.4032698460364341, 0.1773649678480625, -0.12441237124403319, -0.11856537296444178, -0.1972424225145578, -0.08975264206628004] ,
                    # [0.4063169687604904, 0.1409647883284092, -0.09589381532371044, -0.13976786500975488, -0.1439439134657383, -0.05131746167242527] ,
                    # [0.1305099457323551, 0.15553087715744973, -0.26539181153376895, -0.07028747447729111, -0.2003922084760666, -0.14476536809007326] ,
                    # [-0.14930062105983496, 0.11383996065020562, -0.004723019542420904, 0.43824177013635635, -0.1685459322875738, -0.08672332406938076] ,
                    # [-0.13355198641866442, 0.15047479743659498, 0.0016673073858022689, 0.39823706259489056, -0.18661475500196217, -0.17988530172804992] ,
                    # [-0.16433259038023648, 0.10893438298344613, -0.012237893912444514, 0.43803126185178753, -0.1553781449574232, -0.10397463249663512] ,
                    # [-0.16158639114022252, 0.13558668209433555, 0.009210227116321525, 0.3780707275056839, -0.1933752128186822, -0.17457509469191232] ,
                    # [0.3782220276021957, 0.18974480307877062, -0.10451143445273241, -0.16838520418733358, -0.18759442312687635, -0.04162255816161632] ,
                    # [0.4142512157869339, 0.1504626737511158, -0.09189183302621047, -0.1479380155609548, -0.18283917806684968, -0.050983650368452066] ,
                    # [0.41281320894479745, 0.1499222459858656, -0.10495094082653522, -0.14356633100390434, -0.19448353522002698, -0.055336224724849066] ,
                    # [0.40444180958747866, 0.15500467203855514, -0.11136605398654938, -0.13205198370605706, -0.19247079572081566, -0.05543528766135375] ,
                    # [-0.15385213299676773, 0.17530175489902494, 0.03885886029290656, 0.26887561126232146, -0.2302340754163265, -0.25887430115044113] ,
                    # [-0.1600240099340677, 0.11575629006624222, -0.019589331290870905, 0.4424647482347488, -0.15224535839259623, -0.09191983739137649] ,
                    # [-0.17138137244969606, 0.12297236451029778, -0.014281893717000883, 0.45095963645696635, -0.14810639338970183, -0.09169082837005456]

                    # [-0.19308575528390706, 0.03581055439531804, -0.03950193353096644, -0.16715637464806435, -0.1117217101046443, -0.03496571831802527] ,
                    # [-0.17805983004160222, 0.07095175094425679, -0.04102363461603721, -0.15738115308746695, -0.1274270646098256, -0.05510127593576908] ,
                    # [-0.07347172931194304, 0.0958561841136217, -0.19200441395044326, -0.06174906561315058, -0.15871526317715645, -0.18554908892711003] ,
                    # [0.05156131486654282, 0.11270786642372609, -0.20780918850700061, 0.04041353687405587, -0.15155083191633223, -0.19979401852190493] ,
                    # [0.06932816598296165, 0.08916920085966587, -0.21497887081404526, 0.060181725322008134, -0.14851267897039652, -0.19621691182057063] ,
                    # [0.07225398625969887, 0.09893593912005424, -0.25117893117666246, 0.09346136221528054, -0.1405990881240368, -0.24243309687674044] ,
                    # [0.26281717933416365, 0.0839672761541605, -0.224202328034242, 0.29472650087356567, -0.12761435860574244, -0.20523326063553493] ,
                    # [0.44813911405086515, 0.07184049689412117, -0.07166399036645889, 0.4440017560648918, -0.12487467898964882, -0.08310243435601393] ,
                    # [0.4614784477043151, 0.09565339388310909, -0.07860406238734721, 0.4594154752612114, -0.09654600979208947, -0.08387372959752877] ,
                    # [0.46154111043214796, 0.09671683459758759, -0.0850988613580664, 0.4661044262909889, -0.09849131470710039, -0.0792899415820837] ,
                    # [0.46461696268320085, 0.09399647198081017, -0.08996321229934692, 0.4629028113007545, -0.12554850555747749, -0.08084135061601798] ,
                    # [0.45329932190895084, 0.07264104275882244, -0.08941607952018579, 0.3336541353869438, -0.1470034058472514, -0.1217518836726745] ,
                    # [0.45994314527988434, 0.07372306802272796, -0.052262854968756434, 0.15073478935599327, -0.09319254810094833, -0.19384876649975777] ,
                    # [0.4457415759897232, 0.08047061504364014, -0.08358561442097028, 0.08720615270495415, -0.08452632673114538, -0.23052287863393625] ,
                    # [0.43619034197807305, 0.08046364037156105, -0.05365392215847969, 0.11850502645611763, -0.19230939437508582, -0.2161956304172675] ,
                    # [0.4728709514164925, 0.06942740247189999, -0.08794224275996287, 0.09883006685376167, -0.3218963965451717, -0.10942374992966651] ,
                    # [0.46940045079231263, 0.05654939199566841, -0.08429713847190141, 0.07273215578436851, -0.34860573929071426, -0.05354294324616592] ,
                    # [0.4346658404564857, 0.0906175713211298, -0.0754888637299339, 0.055908809446096414, -0.34896791936278343, -0.0546489607989788] ,
                    # [0.36583938282489775, 0.09010656180441379, -0.15696559640467167, 0.0505005087852478, -0.33912362340480084, -0.08158690079053244] ,
                    # [0.13992881402373314, 0.033856553004384046, -0.24353465049366158, 0.022394416897296904, -0.3361985738402605, -0.0428658462981383] ,
                    # [0.06837184879779816, 0.050148851308822635, -0.22621313984195393, 0.009957833198308952, -0.3407740243166685, -0.04175614827573299] ,
                    # [0.06939662271738052, 0.21853051007509233, -0.19788961236973604, 0.01016954401254655, -0.3114453095823526, -0.06340268442233403] ,
                    # [0.05052158585071563, 0.3142305322766304, -0.0544387230835855, 0.006848463165760044, -0.2972786792451143, -0.12687522488633793] ,
                    # [0.0308621498131752, 0.3115644037479162, -0.05426555881127715, 0.0019629349482059577, -0.30112435819387434, -0.09868982434471449] ,
                    # [-0.14981101564660668, 0.1737795272517204, -0.06827292958100636, -0.13721573356062175, -0.20583823030620813, -0.06479924043118954] ,
                    # [-0.19913172531511633, 0.0577318503510952, -0.04149862472514312, -0.17925482886835933, -0.13582610028535128, -0.02582261194388072] ,
                    # [-0.20051629269532859, 0.025563984932899478, -0.04745087328354518, -0.1791383064764738, -0.0937835968992114, -0.04463908561567465] ,

                    # [0.13915724754333497, 0.13369391217827797, -0.16172572851181027, 0.05217566490173339, -0.1923106360435486, -0.13878521919250486] ,
                    # [0.1370602071285248, 0.1304665046930313, -0.1773603844642639, 0.04722418785095214, -0.1980897831916809, -0.1654473304748535] ,
                    # [0.13644413352012635, 0.1257566674798727, -0.13853508114814755, 0.048731678724288935, -0.2025827395915985, -0.12557396888732908] ,
                    # [0.1604787826538086, 0.1227508905529976, -0.12648823738098142, 0.056953066587448115, -0.2060375499725342, -0.10432729721069334] ,
                    # [0.17295141220092775, 0.12438636600971223, -0.07698425531387326, 0.06200873255729675, -0.21305002450942995, -0.0527311325073242] ,
                    # [0.2768555998802185, 0.08767641067504883, -0.06423181176185605, 0.00928931832313537, -0.2313093113899231, -0.03723583221435545] ,
                    # [0.3682826280593872, 0.08058386027812958, -0.05888324856758115, -0.0016781449317932184, -0.24124899387359622, 0.02872457504272463] ,
                    # [0.2104934573173523, 0.1461434978246689, -0.11289054036140439, 0.04406606554985046, -0.21010805845260622, -0.12646660804748533] ,
                    # [0.13074783682823182, 0.16831010758876802, -0.14131694912910459, 0.16032710075378417, -0.19394124031066895, -0.17908296585083006] ,
                    # [0.09265739917755128, 0.19172974705696105, -0.13241526365280148, 0.3503900408744812, -0.14592571437358856, -0.2313357353210449] ,
                    # [0.06862674355506898, 0.19518580317497253, -0.03234794616699216, 0.19162251949310302, -0.13776342451572418, -0.18066368103027342] ,
                    # [0.06099326610565187, 0.18495525598526003, -0.10258725166320798, 0.12370898723602294, -0.1558545160293579, -0.16957626342773435] ,
                    # [0.15574647188186647, 0.15512140274047853, -0.10200098037719724, 0.0949220597743988, -0.1785623598098755, -0.1204052925109863] ,
                    # [0.1845043420791626, 0.12872991889715196, -0.14852833628654477, 0.09356003403663635, -0.20371795177459717, -0.11397848129272459] ,
                    # [0.18311832547187806, 0.10381001114845276, -0.07741102457046506, 0.06758105158805847, -0.20583331465721133, -0.05429134368896482] ,
                    # [0.17072458267211915, 0.0924215304851532, -0.11627322316169736, 0.04961585402488708, -0.21522070050239564, -0.08545575141906736] ,
                    # [0.2899820327758789, 0.0671016025543213, -0.10226198911666867, 0.007969880104064936, -0.24529819965362548, 0.044569635391235374] ,
                    # [0.3259407997131348, 0.07901499748229981, -0.26332753777503964, -0.10606423616409302, -0.22686243534088135, 0.33787288665771487] ,
                    # [0.15588019490242006, 0.13266299545764923, -0.2791893172264099, -0.22379062175750733, -0.20788012623786928, 0.21214976310729983] ,
                    # [0.05532093048095704, 0.17689796268939972, -0.21791800737380979, -0.28170580267906187, -0.23185906887054444, 0.0978569030761719] ,
                    # [0.0020618855953216664, 0.1831468391418457, -0.044221549034118623, -0.008590286970138555, -0.17930445849895477, -0.16278371810913084] ,
                    # [-0.02561490535736083, 0.19288554072380065, 0.06377610683441165, 0.23582490682601928, -0.15350992411375047, -0.17082366943359373] ,
                    # [0.06695155501365663, 0.1820317077636719, -0.02017372727394101, 0.14272802472114562, -0.13732094049453736, -0.2326193809509277] ,
                    # [0.07233945727348329, 0.16774121999740602, -0.07364141821861264, 0.11601083874702453, -0.16005247712135315, -0.18386278152465818] ,
                    # [0.1695720672607422, 0.15697875499725342, -0.12055179357528684, 0.1598975896835327, -0.1834751057624817, -0.15184102058410642] ,
                    # [0.20893449783325196, 0.12785911440849304, -0.17912566542625424, 0.14305826425552368, -0.19452113389968873, -0.15207800865173338] ,
                    # [0.19279770255088807, 0.10039968371391297, -0.09579178571701047, 0.1030157446861267, -0.21111255764961245, -0.09179863929748533] ,
                    # [0.16497610211372377, 0.09007767319679261, -0.08026984214782712, 0.07593961954116821, -0.21187708854675294, -0.07652697563171384] ,
                    # [0.16358442306518556, 0.08092624425888062, -0.054791091680526705, 0.061748975515365595, -0.21722823262214663, -0.046601390838623025] ,
        ]
        use_fix_target=False
        num_fix_targets=7
    
    class init_state(CyberCommonCfg.init_state):
        if init_pose == "stand":
            # stand
            pos = [0.0, 0.0, 0.25] # x,y,z [m]
        elif init_pose == "sit":
            # sit lower
            pos = [0.0, 0.0, 0.11]
        elif init_pose == "upright":
            pos = [0.0, 0.0, 0.39]
            rot = [0.,-np.sin(np.pi / 4),0.,np.cos(np.pi / 4)]
        if init_pose == "stand":
            # stand
            init_joint_angles = {
                'FL_hip_joint': 0.0,
                'RL_hip_joint': 0.0,
                'FR_hip_joint': 0.0,
                'RR_hip_joint': 0.0,
                'FL_thigh_joint': -45 / 57.3, # -80 / 57.3, 
                'RL_thigh_joint': -45 / 57.3, # -80 / 57.3, 
                'FR_thigh_joint': -45 / 57.3, # -80 / 57.3, 
                'RR_thigh_joint': -45 / 57.3, # -80 / 57.3, 
                'FL_calf_joint': 70 / 57.3, # 135 / 57.3,
                'RL_calf_joint': 70 / 57.3, # 135 / 57.3,
                'FR_calf_joint': 70 / 57.3, # 135 / 57.3,
                'RR_calf_joint': 70 / 57.3, # 135 / 57.3,
            }
        elif init_pose == "sit":
            # sit
            init_joint_angles = {
                'FL_hip_joint': 0.0,
                'RL_hip_joint': 0.0,
                'FR_hip_joint': 0.0,
                'RR_hip_joint': 0.0,
                'FL_thigh_joint': -80 / 57.3, 
                'RL_thigh_joint': -80 / 57.3, 
                'FR_thigh_joint': -80 / 57.3, 
                'RR_thigh_joint': -80 / 57.3, 
                'FL_calf_joint': 135 / 57.3,
                'RL_calf_joint': 135 / 57.3,
                'FR_calf_joint': 135 / 57.3,
                'RR_calf_joint': 135 / 57.3,
            }
        elif init_pose == "upright":
            # only for creating env
            init_joint_angles = {
                'FL_hip_joint': 0.0727,
                'FL_thigh_joint': -0.3136, 
                'FL_calf_joint': 1.4936,
                'FR_hip_joint': 0.3127,
                'FR_thigh_joint': 0.1165, 
                'FR_calf_joint': 1.0167,
                'RL_hip_joint': 0.2474,
                'RL_thigh_joint': -2.5143,
                'RL_calf_joint': 1.5880,
                'RR_hip_joint': 0.2927,
                'RR_thigh_joint': -1.4269,
                'RR_calf_joint': 0.8779,
            }
        # init joint angles range
        if init_pose == "upright":
            init_joint_angles_range = {
                'FL_hip_joint': [-0.5786,  0.5786],
                'FL_thigh_joint': [-2.4836,  1.0175],
                'FL_calf_joint': [ 0.6741,  2.3802],
                'FR_hip_joint': [-0.5786,  0.5786], 
                'FR_thigh_joint': [-2.4836,  1.0175],
                'FR_calf_joint': [ 0.6741,  2.3802],
                'RL_hip_joint': [0.1, 0.6],
                'RL_thigh_joint': [-2.65, -2.15],
                'RL_calf_joint': [1.4, 1.7],
                'RR_hip_joint': [-0.6, -0.1],
                'RR_thigh_joint': [-2.65, -2.15],
                'RR_calf_joint': [1.4, 1.7],
            }
        else:
            init_joint_angles_range = {
                key: [value - 0.1, value + 0.1] for (key, value) in init_joint_angles.items()
            }
        randomize_rot = (init_pose == "upright")
    
    class asset(CyberCommonCfg.asset):
        terminate_after_contacts_on = ["base", "head", "FR_thigh", "FL_thigh", "FR_calf", "FL_calf", "FR_foot", "FL_foot", "RL_thigh", "RR_thigh"] # allow calf, add head
        penalize_contacts_on = ["base", "head", "FR_thigh", "FL_thigh", "FR_calf", "FL_calf", "FR_foot", "FL_foot", "RL_calf", "RR_calf", "RL_thigh", "RR_thigh"] # stand
        allow_initial_contacts_on = ["foot", "RL_calf", "RR_calf"]
        max_dof_change = 0.3

        #fix_base_link = True
    
    class control(CyberCommonCfg.control):
        stiffness = {'joint': 30.0}
        damping = {'joint': 3.0}
        decimation = 4
        kp_factor_range = [0.8, 1.2]
        kd_factor_range = [0.8, 1.2]
        
    class commands(CyberCommonCfg.commands):
        zero_cmd_threshold = 0.0
        curriculum = use_vel # for no vel expr
        discretize = True
        separate_lin_ang = False
        clip_ang_vel = 0.25 * np.pi
        default_gait_freq = 2.5
        # resampling_time = 5
        class ranges(CyberCommonCfg.commands.ranges):
            lin_vel_x = [-0.3, 0.3]
            lin_vel_y = [-0.0, 0.0]
            ang_vel_yaw = [-0.3, 0.3]    # min max [rad/s]
            heading = [-0.5 * np.pi, 0.5 * np.pi]

    class normalization(CyberCommonCfg.normalization):
        class obs_scales(CyberCommonCfg.normalization.obs_scales):
            dof_vel = 0.

    class rewards(CyberCommonCfg.rewards):
        curriculum = (init_pose == "sit")
        cl_init = 0.6
        cl_step = 0.2
        soft_dof_pos_limit = 0.95
        soft_dof_pos_low = None
        soft_dof_pos_high = None
        soft_torque_limit = 0.5
        
        dof_sigma = 0.1
        tracking_sigma = 0.05#0.05
        tracking_liftup_sigma = 0.03
        tracking_pos_sigma = 0.02
        tracking_ang_sigma = 0.2
        
        liftup_target = 0.42
        lift_up_threshold = [0.15, 0.42]
        scale_factor_low = 0.25
        scale_factor_high = 0.35
        foot_target = 0.05
        if init_pose == "upright":
            allow_contact_steps = 0
        elif init_pose == "sit":
            allow_contact_steps = 30 
        else:
            allow_contact_steps = 50 # !! change with init pose
        before_handtrack_steps = 0 if init_pose == "upright" else 50
        upright_vec = [0.2, 0.0, 1.0]
        ang_rew_mode = "heading"

        class scales(CyberCommonCfg.rewards.scales):
            feet_slip = -0.04 * 10
            feet_clearance_cmd_linear = -300
            collision = -2.0
            torque_limits = -0.01
            tracking_lin_vel = 0.6#0.5*1.0
            tracking_ang_vel = 0.5*0.5
            nominal_state = 0.0 if use_vel else 0.0
            rear_air = -0.5
            action_rate = -0.03
            action_q_diff = -0.5 * 2 if init_pose == "sit" else 0.
            stand_air = -50 * 0
            dof_vel = -1e-4
            dof_acc = -2.5e-7
            dof_pos_limits = -10
            upright = 1.0
            # lift_up = 1.0
            lift_up_linear = 0.5
            
            tracking_hand_pos = 1.0
            foot_twist = -0
            foot_shift = -50
            # hip_still = -100
            
    
    class domain_rand(CyberCommonCfg.domain_rand):
        push_interval_s = 5
        max_push_vel_xy = 0.2
        
        joint_friction_range = [0.03, 0.08]
        joint_damping_range = [0.02, 0.06]
        added_mass_range = [-0.5, 0.5]
        com_displacement_range = [[-0.01, 0.0, -0.01], [0.01, 0.0, 0.01]]
        

class CyberStandDanceCfgPPO(CyberCommonCfgPPO):
    class runner(CyberCommonCfgPPO.runner):
        experiment_name = "stand_dance_cyber"
        max_iterations = 20000
        save_interval = 300